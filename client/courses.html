<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>UTN - Cursos</title>
    </head>

<body>
    <h1>UTN - Cursos</h1>
<hr>

<button onclick="location.href='index.html'">Regresar</button>

<h2 id="formTitle">Crear curso</h2>

<form id="courseForm">
    <input type="hidden" id="courseId">

    <label>Nombre<br><input id="nombre" required></label><br><br>

    <label>Código<br><input id="codigo" required></label><br><br>

    <label>Descripción<br><textarea id="descripcion" required></textarea></label><br><br>

    <label>Profesor<br><select id="profesor"></select></label><br><br>

    <button type="submit">Guardar</button>

    <button type="button" id="cancelar" style="display:none;">Cancelar</button>
</form>

<h3>Lista de cursos</h3>

<table border="1" cellpadding="8">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Código</th>
            <th>Descripción</th>
            <th>Profesor</th>
            <th>Acciones</th>
        </tr>
    </thead>
  <tbody id="tablaCursos"></tbody>
</table>

<script>
// URL base de la API (ajustar si el servidor corre en otro puerto o dominio)
const API = "http://localhost:3001";

// Función fetch segura que maneja errores y respuestas vacías
async function api(url, options = {}) {
    const res = await fetch(url, options);
    if (res.status === 204) return null; // No Content
    const data = await res.json();
    if (!res.ok) throw data; // Si la respuesta no es OK, lanzar el error
    return data;
}

// Referencias a elementos del DOM
const form = document.getElementById("courseForm");
const titulo = document.getElementById("formTitle");
const tablaCursos = document.getElementById("tablaCursos");
const cancelar = document.getElementById("cancelar");

// Campos del formulario
const id = document.getElementById("courseId");
const nombre = document.getElementById("nombre");   
const codigo = document.getElementById("codigo");
const descripcion = document.getElementById("descripcion");
const profesorSelect = document.getElementById("profesor");

// Función para resetear el formulario a su estado inicial (para crear un nuevo curso)
function resetForm() {
    form.reset();
    id.value = "";
    cancelar.style.display = "none";
    titulo.textContent = "Crear curso";
}

// Cargar profesores para el select
async function cargarProfesores() {
    const profesores = await api(`${API}/professor`);
    profesorSelect.innerHTML = `<option value="">Sin profesor</option>`;
    profesores.forEach(p => {
        profesor.innerHTML += `
        <option value="${p._id}">
            ${p.nombre} ${p.apellidos}
        </option>`;
    });
}

// Cargar cursos y mostrarlos en la tabla
async function cargarCursos() {
    const cursos = await api(`${API}/course`);
    tablaCursos.innerHTML = "";

    cursos.forEach(c => {
        tablaCursos.innerHTML += `
            <tr>
                <td>${c.nombre}</td>
                <td>${c.codigo}</td>
                <td>${c.descripcion}</td>
                <td>${c.profesorId ? c.profesorId.nombre + " " + c.profesorId.apellidos : "Sin profesor"}</td>
                <td>
                    <button onclick="editar('${c._id}')">Editar</button>
                    <button onclick="eliminar('${c._id}')">Eliminar</button>
                </td>
            </tr>`;
    });
}

// Guardar curso (crear o actualizar)
form.addEventListener("submit", async e => {
    e.preventDefault();

    const cursoData = {
        nombre: nombre.value,
        codigo: codigo.value,
        descripcion: descripcion.value,
        profesorId: profesorSelect.value || null
    };

    try {
        if (id.value) {
            // Actualizar curso existente
            await api(`${API}/course/${id.value}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(cursoData)
            });
            alert("Curso actualizado");
        } else {
            // Crear nuevo curso
            await api(`${API}/course`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(cursoData)
            });
            alert("Curso creado");
        }
        resetForm();
        cargarCursos();
    } catch (err) {
        alert(err.message || "Error al guardar el curso");
    }
});

// Editar curso: cargar datos al formulario
async function editar(idCourse) {
    const curso = await api(`${API}/course?id=${idCourse}`);
    id.value = curso._id;
    nombre.value = curso.nombre;
    codigo.value = curso.codigo;
    descripcion.value = curso.descripcion;
    profesorSelect.value = curso.profesorId?._id || "";
    
    titulo.textContent = "Editar curso";
    cancelar.style.display = "inline";
}

// Eliminar curso
async function eliminar(idCourse) {
    if (!confirm("¿Eliminar curso?")) return;

    try {
        await api(`${API}/course/${idCourse}`, {
            method: "DELETE"
        });
        alert("Curso eliminado");
        cargarCursos();
    } catch (err) {
        alert(err.message || "Error al eliminar el curso");
    }
}

// Cancelar edición
cancelar.onclick = resetForm;

// Cargar datos al inicio
cargarProfesores();
cargarCursos();

</script>

</body>
</html>