<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>UTN - Profesores</title>
    </head>
<body>
    <h1>UTN - Profesores</h1>
<hr>

<button onclick="location.href='index.html'">Regresar</button>

<h2 id="tituloForm">Crear profesor</h2>

<form id="formProfesor">
    <input type="hidden" id="id">

    <label>Nombre<br><input id="nombre" required></label><br><br>

    <label>Apellidos<br><input id="apellidos" required></label><br><br>

    <label>Cédula<br><input id="cedula" required></label><br><br>

    <label>Edad<br><input id="edad" type="number" min="18" required></label><br><br>

    <button type="submit">Guardar</button>

    <button type="button" id="cancelar" style="display:none;">Cancelar</button>
</form>

<h3>Lista de profesores</h3>

<table border="1" cellpadding="8">
    <thead>
        <tr>
        <th>Nombre</th>
        <th>Apellidos</th>
        <th>Cédula</th>
        <th>Edad</th>
        <th>Acciones</th>
        </tr>
    </thead>
  <tbody id="tabla"></tbody>
</table>

<script>

// URL base de la API (ajustar si el servidor corre en otro puerto o dominio)
const API = "http://localhost:3001";

// Función fetch segura que maneja errores y respuestas vacías
async function api(url, options = {}) {
    const res = await fetch(url, options);
    if (res.status === 204) return null; // No Content
    const data = await res.json();
    if (!res.ok) throw data; // Si la respuesta no es OK, lanzar el error
    return data;
}

// Referencias a elementos del DOM
const form = document.getElementById('formProfesor');
const tabla = document.getElementById('tabla');
const tituloForm = document.getElementById('tituloForm');
const cancelarBtn = document.getElementById('cancelar');

//Campos del formulario
const id = document.getElementById('id');
const nombre = document.getElementById('nombre');
const apellidos = document.getElementById('apellidos');
const cedula = document.getElementById('cedula');
const edad = document.getElementById('edad');

// Función para resetear el formulario a su estado inicial (para crear un nuevo profesor)
function resetForm() {
    form.reset();
    id.value = '';
    cancelarBtn.style.display = 'none';
    tituloForm.textContent = 'Crear profesor';
}

// Función para cargar y mostrar la lista de profesores
async function cargarProfesores() {
    const profesores = await api(`${API}/professor`);
    tabla.innerHTML = '';

    if (!profesores.length) {
        tabla.innerHTML = '<tr><td colspan="5">No hay profesores registrados</td></tr>';
        return;
    }

    profesores.forEach(profesor => {
        tabla.innerHTML += `
            <tr>
                <td>${profesor.nombre}</td>
                <td>${profesor.apellidos}</td>
                <td>${profesor.cedula}</td>
                <td>${profesor.edad}</td>
                <td>
                    <button onclick="editarProfesor('${profesor._id}')">Editar</button>
                    <button onclick="eliminarProfesor('${profesor._id}')">Eliminar</button>
                </td>
            </tr>
        `;
    });
}

// Manejar el envío del formulario para crear o actualizar un profesor
form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const profesorData = {
        nombre: nombre.value,
        apellidos: apellidos.value,
        cedula: cedula.value,
        edad: parseInt(edad.value)
    };

    try {
        if (id.value) {
            // Actualizar profesor existente
            await api(`${API}/professor/${id.value}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(profesorData)
            });
        } else {
            // Crear nuevo profesor
            await api(`${API}/professor`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(profesorData)
            });
        }

        resetForm();
        cargarProfesores();
    } catch (error) {
        alert(error.message || 'Error al guardar el profesor');
    }
});

// Función para cargar los datos de un profesor en el formulario para editar
async function editarProfesor(profesorId) {
    const profesor = await api(`${API}/professor?id=${profesorId}`);

    id.value = profesor._id;
    nombre.value = profesor.nombre;
    apellidos.value = profesor.apellidos;
    cedula.value = profesor.cedula;
    edad.value = profesor.edad;

    tituloForm.textContent = 'Editar profesor';
    cancelarBtn.style.display = 'inline';
}

// Función para eliminar un profesor
async function eliminarProfesor(profesorId) {
    if (!confirm('¿Está seguro de eliminar este profesor?')) return;

    try {
        await api(`${API}/professor/${profesorId}`, { method: 'DELETE' });
        cargarProfesores();
    } catch (error) {
        alert(error.message || 'Error al eliminar el profesor');
    }
}

// Manejar el clic en el botón cancelar para resetear el formulario
cancelarBtn.addEventListener('click', resetForm);

// Cargar la lista de profesores al cargar la página
cargarProfesores();
</script>

</body>
</html>